name: Build Desktop App

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g. 0.0.1)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            arch: x64
          - os: windows-latest
            platform: win
            arch: x64
          - os: macos-latest
            platform: mac
            arch: arm64
          - os: macos-latest
            platform: mac
            arch: x64

    runs-on: ${{ matrix.os }}
    name: Build (${{ matrix.platform }}-${{ matrix.arch }})

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: zip, sqlite3, fileinfo
          tools: composer:v2

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install Node dependencies
        run: npm ci

      - name: Install Electron dependencies
        run: npm ci
        working-directory: nativephp/electron

      - name: Build Electron plugin
        run: npm run plugin:build
        working-directory: nativephp/electron

      - name: Install Composer dependencies
        run: composer install --no-interaction --prefer-dist --optimize-autoloader

      - name: Copy environment file
        shell: bash
        run: cp .env.example .env

      - name: Generate application key
        run: php artisan key:generate

      - name: Configure production environment
        shell: bash
        run: |
          if [[ "$RUNNER_OS" == "macOS" ]]; then
            SED_INPLACE=(sed -i '')
          else
            SED_INPLACE=(sed -i)
          fi
          "${SED_INPLACE[@]}" 's/APP_ENV=local/APP_ENV=production/' .env
          "${SED_INPLACE[@]}" 's/APP_DEBUG=true/APP_DEBUG=false/' .env
          "${SED_INPLACE[@]}" 's/GITHUB_REPO=/GITHUB_REPO=vaxtly/' .env
          "${SED_INPLACE[@]}" 's/GITHUB_OWNER=/GITHUB_OWNER=vaxtly/' .env
          "${SED_INPLACE[@]}" 's/GITHUB_RELEASE_TYPE=draft/GITHUB_RELEASE_TYPE=release/' .env
          "${SED_INPLACE[@]}" "s/GITHUB_TOKEN=/GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }}/" .env

      - name: Set version
        shell: bash
        run: |
          VERSION="${{ inputs.version }}"
          VERSION="${VERSION#v}"
          if [[ "$RUNNER_OS" == "macOS" ]]; then
            sed -i '' "s/'version' => env('NATIVEPHP_APP_VERSION', '[^']*')/'version' => env('NATIVEPHP_APP_VERSION', '$VERSION')/" config/nativephp.php
          else
            sed -i "s/'version' => env('NATIVEPHP_APP_VERSION', '[^']*')/'version' => env('NATIVEPHP_APP_VERSION', '$VERSION')/" config/nativephp.php
          fi

      - name: Ensure extras directory exists
        run: mkdir -p extras

      - name: Build and publish native app
        shell: bash
        env:
          NATIVEPHP_APPLE_ID_SECRET: ${{ secrets.NATIVEPHP_APPLE_ID }}
          NATIVEPHP_APPLE_ID_PASS_SECRET: ${{ secrets.NATIVEPHP_APPLE_ID_PASS }}
          NATIVEPHP_APPLE_TEAM_ID_SECRET: ${{ secrets.NATIVEPHP_APPLE_TEAM_ID }}
          CSC_LINK_SECRET: ${{ secrets.CSC_LINK }}
          CSC_KEY_PASSWORD_SECRET: ${{ secrets.CSC_KEY_PASSWORD }}
        run: |
          if [[ -n "$CSC_LINK_SECRET" ]]; then
            export CSC_LINK="$CSC_LINK_SECRET"
            export CSC_KEY_PASSWORD="$CSC_KEY_PASSWORD_SECRET"
          else
            export CSC_IDENTITY_AUTO_DISCOVERY=false
          fi
          if [[ -n "$NATIVEPHP_APPLE_ID_SECRET" ]]; then
            export NATIVEPHP_APPLE_ID="$NATIVEPHP_APPLE_ID_SECRET"
            export NATIVEPHP_APPLE_ID_PASS="$NATIVEPHP_APPLE_ID_PASS_SECRET"
            export NATIVEPHP_APPLE_TEAM_ID="$NATIVEPHP_APPLE_TEAM_ID_SECRET"
          fi
          php artisan native:build ${{ matrix.platform }} ${{ matrix.arch }} --publish --no-interaction

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: vaxtly-${{ matrix.platform }}-${{ matrix.arch }}
          path: |
            nativephp/electron/dist/*.deb
            nativephp/electron/dist/*.AppImage
            nativephp/electron/dist/*.exe
            nativephp/electron/dist/*-setup.exe
            nativephp/electron/dist/*.dmg
            nativephp/electron/dist/*.zip
          retention-days: 30

  update-homebrew:
    needs: build
    runs-on: ubuntu-latest
    name: Update Homebrew tap
    steps:
      - name: Wait for release assets
        shell: bash
        run: |
          VERSION="${{ inputs.version }}"
          VERSION="${VERSION#v}"
          for i in $(seq 1 30); do
            ARM64=$(curl -sL -o /dev/null -w '%{http_code}' "https://github.com/vaxtly/vaxtly/releases/download/v${VERSION}/Vaxtly-${VERSION}-arm64.dmg")
            X64=$(curl -sL -o /dev/null -w '%{http_code}' "https://github.com/vaxtly/vaxtly/releases/download/v${VERSION}/Vaxtly-${VERSION}-x64.dmg")
            if [[ "$ARM64" == "200" && "$X64" == "200" ]]; then
              echo "Both DMGs available"
              break
            fi
            echo "Waiting for release assets... (attempt $i)"
            sleep 10
          done

      - name: Compute SHA256 hashes
        id: hashes
        shell: bash
        run: |
          VERSION="${{ inputs.version }}"
          VERSION="${VERSION#v}"
          SHA_ARM64=$(curl -sL "https://github.com/vaxtly/vaxtly/releases/download/v${VERSION}/Vaxtly-${VERSION}-arm64.dmg" | sha256sum | awk '{print $1}')
          SHA_X64=$(curl -sL "https://github.com/vaxtly/vaxtly/releases/download/v${VERSION}/Vaxtly-${VERSION}-x64.dmg" | sha256sum | awk '{print $1}')
          echo "sha_arm64=$SHA_ARM64" >> "$GITHUB_OUTPUT"
          echo "sha_x64=$SHA_X64" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Update cask formula
        env:
          GH_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        shell: bash
        run: |
          VERSION="${{ steps.hashes.outputs.version }}"
          SHA_ARM64="${{ steps.hashes.outputs.sha_arm64 }}"
          SHA_X64="${{ steps.hashes.outputs.sha_x64 }}"

          CASK_CONTENT=$(cat <<'RUBY'
          cask "vaxtly" do
            version "VERSION_PLACEHOLDER"

            on_arm do
              sha256 "SHA_ARM64_PLACEHOLDER"
              url "https://github.com/vaxtly/vaxtly/releases/download/v#{version}/Vaxtly-#{version}-arm64.dmg"
            end

            on_intel do
              sha256 "SHA_X64_PLACEHOLDER"
              url "https://github.com/vaxtly/vaxtly/releases/download/v#{version}/Vaxtly-#{version}-x64.dmg"
            end

            name "Vaxtly"
            desc "API testing tool"
            homepage "https://vaxtly.github.io"

            app "Vaxtly.app"

            zap trash: [
              "~/Library/Application Support/Vaxtly",
              "~/Library/Preferences/com.vaxtly.app.plist",
              "~/Library/Saved Application State/com.vaxtly.app.savedState",
            ]
          end
          RUBY
          )

          CASK_CONTENT="${CASK_CONTENT//VERSION_PLACEHOLDER/$VERSION}"
          CASK_CONTENT="${CASK_CONTENT//SHA_ARM64_PLACEHOLDER/$SHA_ARM64}"
          CASK_CONTENT="${CASK_CONTENT//SHA_X64_PLACEHOLDER/$SHA_X64}"

          # Remove leading whitespace from heredoc
          CASK_CONTENT=$(echo "$CASK_CONTENT" | sed 's/^          //')

          # Get current file SHA for update
          FILE_SHA=$(gh api repos/vaxtly/homebrew-tap/contents/Casks/vaxtly.rb --jq '.sha' 2>/dev/null || echo "")

          ENCODED=$(echo "$CASK_CONTENT" | base64 -w0)

          if [[ -n "$FILE_SHA" ]]; then
            gh api repos/vaxtly/homebrew-tap/contents/Casks/vaxtly.rb \
              -X PUT \
              -f message="Update Vaxtly to v${VERSION}" \
              -f committer[name]="vaxtly" \
              -f committer[email]="vaxtly.app@gmail.com" \
              -f content="$ENCODED" \
              -f sha="$FILE_SHA"
          else
            gh api repos/vaxtly/homebrew-tap/contents/Casks/vaxtly.rb \
              -X PUT \
              -f message="Update Vaxtly to v${VERSION}" \
              -f committer[name]="vaxtly" \
              -f committer[email]="vaxtly.app@gmail.com" \
              -f content="$ENCODED"
          fi

          echo "Homebrew tap updated to v${VERSION}"
